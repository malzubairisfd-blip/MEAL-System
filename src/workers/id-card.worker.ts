// src/workers/id-card.worker.ts
import { jsPDF } from "jspdf";
import JSZip from "jszip";

// --- TYPES & INTERFACES ---

export interface IDCardData {
  beneficiaryName: string;
    governorate: string;
      district: string;
        uzla: string;
          village: string;
            beneficiaryId: string;
              cardExpiry: string;
                educatorName?: string;
                  // Optional: Pass specific branch name if dynamic
                    branchName?: string; 
                    }

                    // --- CONSTANTS & CONFIGURATION ---

                    // Standard CR80 ID Card dimensions (mm)
                    const CARD_WIDTH = 85.6;
                    const CARD_HEIGHT = 53.98;

                    // Colors extracted from reference image
                    const COLORS = {
                      primaryBrown: "#6F3B35", // The dark maroon/brown
                        primaryGold: "#C8AA68",  // The tan/gold accent
                          textBlack: "#000000",
                            textWhite: "#FFFFFF",
                              photoPlaceholder: "#F0F0F0",
                                borderGold: "#8B6F3E",   // Darker gold for borders
                                };

                                // Layout constants
                                const MARGIN = 4;

                                // --- HELPER FUNCTIONS ---

                                /**
                                 * Draw Arabic text with proper alignment and font settings
                                  */
                                  function drawText(
                                    doc: jsPDF,
                                    text: string,
                                    x: number,
                                    y: number,
                                    size: number,
                                    color: string,
                                    align: "left" | "center" | "right" = "right",
                                    isBold = false
                                  ) {
                                    doc.setTextColor(color);
                                    doc.setFont("NotoNaskhArabic", isBold ? "bold" : "normal");
                                    doc.setFontSize(size);
                                    doc.text(String(text || ''), x, y, { align, baseline: "middle" });
                                  }

                                /**
                                 * Draw decorative border with brown and gold accents
                                  */
                                  function drawDecorativeBorder(doc: jsPDF) {
                                    // Main brown border (outer)
                                    doc.setDrawColor(COLORS.BROWN_DARK);
                                    doc.setLineWidth(1.2);
                                    doc.roundedRect(2, 2, CARD_WIDTH - 4, CARD_HEIGHT - 4, 3, 3, "S");
                                    
                                    // Inner gold border
                                    doc.setDrawColor(COLORS.GOLD_MEDIUM);
                                    doc.setLineWidth(0.6);
                                    doc.roundedRect(3.5, 3.5, CARD_WIDTH - 7, CARD_HEIGHT - 7, 2, 2, "S");
                                    
                                    // Decorative gold corners
                                    const cornerSize = 5;
                                    doc.setFillColor(COLORS.GOLD_MEDIUM);
                                    
                                    // Top-left corner
                                    doc.rect(3.5, 3.5, cornerSize, 1.5, "F");
                                    doc.rect(3.5, 3.5, 1.5, cornerSize, "F");
                                    
                                    // Top-right corner
                                    doc.rect(CARD_WIDTH - 3.5 - cornerSize, 3.5, cornerSize, 1.5, "F");
                                    doc.rect(CARD_WIDTH - 3.5 - 1.5, 3.5, 1.5, cornerSize, "F");
                                    
                                    // Bottom-left corner
                                    doc.rect(3.5, CARD_HEIGHT - 3.5 - 1.5, cornerSize, 1.5, "F");
                                    doc.rect(3.5, CARD_HEIGHT - 3.5 - cornerSize, 1.5, cornerSize, "F");
                                    
                                    // Bottom-right corner
                                    doc.rect(CARD_WIDTH - 3.5 - cornerSize, CARD_HEIGHT - 3.5 - 1.5, cornerSize, 1.5, "F");
                                    doc.rect(CARD_WIDTH - 3.5 - 1.5, CARD_HEIGHT - 3.5 - cornerSize, 1.5, cornerSize, "F");
                                  }

                                /**
                                 * Draw decorative shapes on left side (abstract swooshes/curves)
                                  */
                                  function drawLeftSideShapes(doc: jsPDF) {
                                    // Large brown curve (bottom-left)
                                    doc.setFillColor(COLORS.BROWN_MEDIUM);
                                    doc.path([
                                      { op: 'm', c: [0, CARD_HEIGHT] },
                                      { op: 'c', c: [15, CARD_HEIGHT - 10, 25, CARD_HEIGHT - 25, 0, CARD_HEIGHT - 35] },
                                      { op: 'l', c: [0, CARD_HEIGHT] },
                                      { op: 'h', c: [] }
                                    ]).fill();
                                    
                                    // Medium gold curve (overlapping)
                                    doc.setFillColor(COLORS.GOLD_MEDIUM);
                                    doc.path([
                                      { op: 'm', c: [0, CARD_HEIGHT - 15] },
                                      { op: 'c', c: [12, CARD_HEIGHT - 18, 20, CARD_HEIGHT - 30, 0, CARD_HEIGHT - 40] },
                                      { op: 'l', c: [0, CARD_HEIGHT - 15] },
                                      { op: 'h', c: [] }
                                    ]).fill();
                                    
                                    // Small dark brown curve (top-left)
                                    doc.setFillColor(COLORS.BROWN_DARK);
                                    doc.path([
                                      { op: 'm', c: [0, CARD_HEIGHT - 30] },
                                      { op: 'c', c: [8, CARD_HEIGHT - 32, 15, CARD_HEIGHT - 40, 0, CARD_HEIGHT - 45] },
                                      { op: 'l', c: [0, CARD_HEIGHT - 30] },
                                      { op: 'h', c: [] }
                                    ]).fill();
                                  }

                                /**
                                 * Draw decorative shapes on right side (matching left side)
                                  */
                                  function drawRightSideShapes(doc: jsPDF) {
                                    // Large brown curve (bottom-right)
                                    doc.setFillColor(COLORS.BROWN_MEDIUM);
                                    doc.path([
                                      { op: 'm', c: [CARD_WIDTH, CARD_HEIGHT] },
                                      { op: 'c', c: [CARD_WIDTH - 15, CARD_HEIGHT - 10, CARD_WIDTH - 25, CARD_HEIGHT - 25, CARD_WIDTH, CARD_HEIGHT - 35] },
                                      { op: 'l', c: [CARD_WIDTH, CARD_HEIGHT] },
                                      { op: 'h', c: [] }
                                    ]).fill();
                                    
                                    // Medium gold curve (overlapping)
                                    doc.setFillColor(COLORS.GOLD_MEDIUM);
                                    doc.path([
                                      { op: 'm', c: [CARD_WIDTH, CARD_HEIGHT - 15] },
                                      { op: 'c', c: [CARD_WIDTH - 12, CARD_HEIGHT - 18, CARD_WIDTH - 20, CARD_HEIGHT - 30, CARD_WIDTH, CARD_HEIGHT - 40] },
                                      { op: 'l', c: [CARD_WIDTH, CARD_HEIGHT - 15] },
                                      { op: 'h', c: [] }
                                    ]).fill();
                                    
                                    // Small dark brown curve (top-right)
                                    doc.setFillColor(COLORS.BROWN_DARK);
                                    doc.path([
                                      { op: 'm', c: [CARD_WIDTH, CARD_HEIGHT - 30] },
                                      { op: 'c', c: [CARD_WIDTH - 8, CARD_HEIGHT - 32, CARD_WIDTH - 15, CARD_HEIGHT - 40, CARD_WIDTH, CARD_HEIGHT - 45] },
                                      { op: 'l', c: [CARD_WIDTH, CARD_HEIGHT - 30] },
                                      { op: 'h', c: [] }
                                    ]).fill();
                                  }
                                /**
                                 * Draw dotted line for data fields
                                  */
                                  function drawDottedLine(doc: jsPDF, x1: number, y: number, x2: number) {
                                    doc.setDrawColor(COLORS.DOTTED_LINE);
                                    doc.setLineWidth(0.1);
                                    
                                    // Create dotted effect manually
                                    const dashLength = 1;
                                    const gapLength = 1;
                                    let currentX = x1;
                                    
                                    while (currentX < x2) {
                                      const endX = Math.min(currentX + dashLength, x2);
                                      doc.line(currentX, y, endX, y);
                                      currentX = endX + gapLength;
                                    }
                                  }

                                            /**
                                             * Draws the specific SFD Logo (Simulated geometric representation)
                                              * Ideally, replace this with doc.addImage if you have the PNG/JPG
                                               */
                                               const drawLogo = (doc: jsPDF, x: number, y: number, size: number) => {
                                                // --- SFD LOGO (Manual Vector Drawing) ---
                                                const logoX = x;
                                                const logoY = y;
                                                doc.setFillColor(40, 60, 80); // SFD Blue
                                                doc.rect(logoX, logoY, 6, 15, "F");
                                                
                                                doc.setTextColor(255, 255, 255);
                                                doc.setFontSize(9);
                                                doc.setFont("helvetica", "bold");
                                                doc.text("S", logoX + 3, logoY + 4, { align: "center", baseline: "middle" });
                                                doc.text("F", logoX + 3, logoY + 8, { align: "center", baseline: "middle" });
                                                doc.text("D", logoX + 3, logoY + 12, { align: "center", baseline: "middle" });
                                                
                                                doc.setFont("NotoNaskhArabic", "normal");
                                                doc.setTextColor(40, 60, 80);
                                                doc.setFontSize(10);
                                                doc.text("الصندوق", logoX + 8, logoY + 4);
                                                doc.text("الاجتماعي", logoX + 8, logoY + 9);
                                                doc.text("للتنمية", logoX + 8, logoY + 14);
                                                
                                                doc.setFont("helvetica", "normal");
                                                doc.setFontSize(6);
                                                doc.text("Social Fund for Development", logoX, logoY + 17);
                                              }

                                                                                       // --- CORE DRAWING FUNCTIONS ---

                                                                                       /**
                                                                                        * Draws the Front Side of the ID Card
                                                                                         */
                                                                                         const drawCardFront = (doc: jsPDF, data: IDCardData) => {
                                                                                           // 1. Background
                                                                                             doc.setFillColor(255, 255, 255);
                                                                                               doc.rect(0, 0, CARD_WIDTH, CARD_HEIGHT, "F");
                                                                                                 
                                                                                                   // 2. Decorative elements
                                                                                                     drawDecorativeBorder(doc);
                                                                                                       drawLeftSideShapes(doc);
                                                                                                         drawRightSideShapes(doc);
                                                                                                           
                                                                                                             // 3. Logo (top-left)
                                                                                                               drawLogo(doc, 5, 5);
                                                                                                                 
                                                                                                                   // 4. Header section (top-right)
                                                                                                                     const headerRightX = CARD_WIDTH - MARGIN - 5;
                                                                                                                       
                                                                                                                         // Organization name (exact text from PDF)
                                                                                                                           drawText(doc, "الصندوق الاجتماعي للتنمية – فرع .................", 
                                                                                                                                    headerRightX, 8, 6, COLORS.TEXT_DARK, "right", true);
                                                                                                                                      
                                                                                                                                        // Program name (exact text from PDF)
                                                                                                                                          drawText(doc, "برنامج التحويلات النقدية المشروطة في التغذية", 
                                                                                                                                                   headerRightX, 12, 6, COLORS.TEXT_DARK, "right");
                                                                                                                                                     
                                                                                                                                                       // 5. Card title (centered)
                                                                                                                                                         drawText(doc, "بطاقة مستفيدة", CARD_WIDTH / 2, 22, 14, COLORS.BROWN_DARK, "center", true);
                                                                                                                                                           
                                                                                                                                                             // Gold decorative line under title
                                                                                                                                                               doc.setDrawColor(COLORS.GOLD_MEDIUM);
                                                                                                                                                                 doc.setLineWidth(0.5);
                                                                                                                                                                   doc.line(CARD_WIDTH / 2 - 20, 25, CARD_WIDTH / 2 + 20, 25);
                                                                                                                                                                     
                                                                                                                                                                       // 6. Photo placeholder (left side)
                                                                                                                                                                         const photoX = 10;
                                                                                                                                                                           const photoY = 30;
                                                                                                                                                                             const photoW = 20;
                                                                                                                                                                               const photoH = 25;
                                                                                                                                                                                 
                                                                                                                                                                                   doc.setFillColor(COLORS.PHOTO_BG);
                                                                                                                                                                                     doc.rect(photoX, photoY, photoW, photoH, "F");
                                                                                                                                                                                       
                                                                                                                                                                                         // Photo border
                                                                                                                                                                                           doc.setDrawColor(COLORS.BROWN_MEDIUM);
                                                                                                                                                                                             doc.setLineWidth(0.3);
                                                                                                                                                                                               doc.rect(photoX, photoY, photoW, photoH, "S");
                                                                                                                                                                                                 
                                                                                                                                                                                                   // "Photo" text placeholder
                                                                                                                                                                                                     drawText(doc, "صورة", photoX + photoW / 2, photoY + photoH / 2, 8, COLORS.TEXT_GRAY, "center");
                                                                                                                                                                                                       
                                                                                                                                                                                                         // ID under photo
                                                                                                                                                                                                           drawText(doc, `2-${data.beneficiaryId}`, photoX + photoW / 2, photoY + photoH + 4, 8, COLORS.BROWN_DARK, "center", true);
                                                                                                                                                                                                             
                                                                                                                                                                                                               // 7. Data fields section (right side)
                                                                                                                                                                                                                 const startY = 32;
                                                                                                                                                                                                                   const rowHeight = 6;
                                                                                                                                                                                                                     const labelX = CARD_WIDTH - MARGIN - 5;
                                                                                                                                                                                                                       const valueX = labelX - 35; // Fixed position for values
                                                                                                                                                                                                                         
                                                                                                                                                                                                                           // Helper function to draw a data row
                                                                                                                                                                                                                             const drawDataRow = (label: string, value: string, y: number) => {
                                                                                                                                                                                                                                 // Draw label
                                                                                                                                                                                                                                   drawText(doc, label + ":", labelX, y, 7, COLORS.BROWN_DARK, "right", true);
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                           // Draw dotted line
                                                                                                                                                                                                                                             const lineStartX = valueX + 2;
                                                                                                                                                                                                                                               const lineEndX = labelX - 5;
                                                                                                                                                                                                                                                 drawDottedLine(doc, lineStartX, y + 1, lineEndX);
                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                         // Draw value (centered over dotted line)
                                                                                                                                                                                                                                                           const valueCenterX = (lineStartX + lineEndX) / 2;
                                                                                                                                                                                                                                                             drawText(doc, value, valueCenterX, y, 7, COLORS.TEXT_DARK, "center");
                                                                                                                                                                                                                                                             };
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                 // Draw all data fields in exact order from PDF
                                                                                                                                                                                                                                                                   drawDataRow("الاسم", data.beneficiaryName, startY);
                                                                                                                                                                                                                                                                     drawDataRow("القرية", data.village, startY + rowHeight);
                                                                                                                                                                                                                                                                       drawDataRow("العزلة", data.uzla, startY + (rowHeight * 2));
                                                                                                                                                                                                                                                                         drawDataRow("المديرية", data.district, startY + (rowHeight * 3));
                                                                                                                                                                                                                                                                           drawDataRow("رقم البطاقة", data.beneficiaryId, startY + (rowHeight * 4));
                                                                                                                                                                                                                                                                             drawDataRow("تاريخ انتهاء البطاقة", data.cardExpiry, startY + (rowHeight * 5));
                                                                                                                                                                                                                                                                             };

                                                                                                                                                                                                                                                                                             /**
                                                                                                                                                                                                                                                                                              * Draws the Back Side of the ID Card
                                                                                                                                                                                                                                                                                               */
                                                                                                                                                                                                                                                                                               const drawCardBack = (doc: jsPDF) => {
                                                                                                                                                                                                                                                                                                 // 1. Background
                                                                                                                                                                                                                                                                                                   doc.setFillColor(255, 255, 255);
                                                                                                                                                                                                                                                                                                     doc.rect(0, 0, CARD_WIDTH, CARD_HEIGHT, "F");
                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                         // 2. Decorative elements
                                                                                                                                                                                                                                                                                                           drawDecorativeBorder(doc);
                                                                                                                                                                                                                                                                                                             drawLeftSideShapes(doc);
                                                                                                                                                                                                                                                                                                               drawRightSideShapes(doc);
                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                   // 3. Header "Important Instructions"
                                                                                                                                                                                                                                                                                                                     doc.setFont("NotoNaskhArabic", "normal");
                                                                                                                                                                                                                                                                                                                       doc.setFontSize(11);
                                                                                                                                                                                                                                                                                                                         doc.setTextColor(COLORS.textBlack);
                                                                                                                                                                                                                                                                                                                           doc.text("تعليمات هامة", CARD_WIDTH - 10, 10, { align: "right" });

                                                                                                                                                                                                                                                                                                                             // 4. Instructions List
                                                                                                                                                                                                                                                                                                                               doc.setFontSize(7);
                                                                                                                                                                                                                                                                                                                                 const instructions = [
                                                                                                                                                                                                                                                                                                                                     "• البطاقة مخصصة لأنشطة البرنامج ولا يجوز استخدامها",
                                                                                                                                                                                                                                                                                                                                         "                لأغراض أخرى",
                                                                                                                                                                                                                                                                                                                                             "• أي كشط او تعديل في بيانات البطاقة يلغيها",
                                                                                                                                                                                                                                                                                                                                                 "• تحصل كل إمرأة امتثلت لشروط البرنامج على مبلغ .......... ريال شهريا خلال مدة تنفيذ",
                                                                                                                                                                                                                                                                                                                                                     "المشروع ولايحق لها التنازل عنه للغير جزئيا أو كليا",
                                                                                                                                                                                                                                                                                                                                                         "• عند اجبار المستفيدة على دفع أو خصم مبلغ منها يتم ابلاغ إدارة المشروع أو البرنامج فورا",
                                                                                                                                                                                                                                                                                                                                                             "• للإبلاغ عن فقدان البطاقة أو تقديم شكوى أو استفسار يتم التواصل عبر أحد الوسائل",
                                                                                                                                                                                                                                                                                                                                                                 "المدونة أدناه"
                                                                                                                                                                                                                                                                                                                                                                   ];
                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                       let textY = 16;
                                                                                                                                                                                                                                                                                                                                                                         const textX = CARD_WIDTH - 8;
                                                                                                                                                                                                                                                                                                                                                                           const bulletX = CARD_WIDTH - 5;

                                                                                                                                                                                                                                                                                                                                                                             instructions.forEach((line, index) => {
                                                                                                                                                                                                                                                                                                                                                                                 // Check if line is a continuation (indented) or new point
                                                                                                                                                                                                                                                                                                                                                                                     const isBullet = [0, 2, 3, 5, 6].includes(index); 
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                             if (isBullet) {
                                                                                                                                                                                                                                                                                                                                                                                                     doc.circle(bulletX, textY - 1, 0.5, 'F'); // Bullet point
                                                                                                                                                                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                 drawText(doc, line, isBullet ? textX : textX, textY, 6, COLORS.BROWN_DARK, "right");
                                                                                                                                                                                                                                                                                                                                                                                                                     textY += 4;
                                                                                                                                                                                                                                                                                                                                                                                                                       });

                                                                                                                                                                                                                                                                                                                                                                                                                         // 5. Gold decorative separator line
                                                                                                                                                                                                                                                                                                                                                                                                                           const separatorY = startY + (instructions.length * 4) + 3;
                                                                                                                                                                                                                                                                                                                                                                                                                             doc.setDrawColor(COLORS.GOLD_MEDIUM);
                                                                                                                                                                                                                                                                                                                                                                                                                               doc.setLineWidth(0.8);
                                                                                                                                                                                                                                                                                                                                                                                                                                 doc.line(10, separatorY, CARD_WIDTH - 10, separatorY);
                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                     // Gold decorative pattern on the line
                                                                                                                                                                                                                                                                                                                                                                                                                                       doc.setFillColor(COLORS.GOLD_LIGHT);
                                                                                                                                                                                                                                                                                                                                                                                                                                         for (let x = 15; x < CARD_WIDTH - 15; x += 6) {
                                                                                                                                                                                                                                                                                                                                                                                                                                             doc.circle(x, separatorY, 0.5, "F");
                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                     // 6. Contact information - exact text from PDF in gold box
                                                                                                                                                                                                                                                                                                                                                                                                                                                       const contactY = separatorY + 8;
                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                           // Gold box for contact info
                                                                                                                                                                                                                                                                                                                                                                                                                                                             doc.setFillColor(COLORS.GOLD_LIGHT);
                                                                                                                                                                                                                                                                                                                                                                                                                                                               doc.roundedRect(10, contactY - 3, CARD_WIDTH - 20, 8, 2, 2, "F");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                   // Brown border around contact box
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     doc.setDrawColor(COLORS.BROWN_DARK);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       doc.setLineWidth(0.5);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                         doc.roundedRect(10, contactY - 3, CARD_WIDTH - 20, 8, 2, 2, "S");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // Contact text in brown
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               drawText(doc, "الاتصال بالرقم  المجاني 8009800  او الرقم الثابت  513821 – 01", 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        CARD_WIDTH / 2, contactY + 1, 8, COLORS.BROWN_DARK, "center", true);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // --- WORKER LOGIC ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.onmessage = async (event) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const { beneficiaries, fontBase64, sample } = event.data;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (!beneficiaries || !fontBase64 || !fontBase64.regular || !fontBase64.bold) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        postMessage({ type: 'error', error: 'Missing beneficiaries data or font files.' });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (sample) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const doc = new jsPDF({ orientation: "landscape", unit: "mm", format: [CARD_WIDTH, CARD_HEIGHT] });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            doc.addFileToVFS("NotoNaskhArabic-Regular.ttf", fontBase64.regular);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        doc.addFileToVFS("NotoNaskhArabic-Bold.ttf", fontBase64.bold);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    doc.addFont("NotoNaskhArabic-Regular.ttf", "NotoNaskhArabic", "normal");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                doc.addFont("NotoNaskhArabic-Bold.ttf", "NotoNaskhArabic", "bold");

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const bnf = beneficiaries[0];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const cardData: IDCardData = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        beneficiaryName: bnf.l_benef_name || '', governorate: bnf.gov_name || '', district: bnf.mud_name || '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        uzla: bnf.hh_ozla_name || '', village: bnf.hh_vill_name || '', beneficiaryId: String(bnf.l_id || ''),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        cardExpiry: bnf.expiry_date || "2024-01-31"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                drawCardFront(doc, cardData);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            doc.addPage([CARD_WIDTH, CARD_HEIGHT], "landscape");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        drawCardBack(doc);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const pdfBuffer = doc.output("arraybuffer");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.postMessage({ type: 'done-sample', data: pdfBuffer }, [pdfBuffer]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const grouped: Record<string, any[]> = {};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            beneficiaries.forEach((row: any) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const edu = row.ED_NAME || "Unassigned_Educator";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (!grouped[edu]) grouped[edu] = [];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                grouped[edu].push(row);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const zip = new JSZip();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const totalEducators = Object.keys(grouped).length;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                let educatorsProcessed = 0;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for (const [educator, bnfs] of Object.entries(grouped)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const doc = new jsPDF({ orientation: "landscape", unit: "mm", format: [CARD_WIDTH, CARD_HEIGHT] });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                doc.addFileToVFS("NotoNaskhArabic-Regular.ttf", fontBase64.regular);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            doc.addFileToVFS("NotoNaskhArabic-Bold.ttf", fontBase64.bold);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        doc.addFont("NotoNaskhArabic-Regular.ttf", "NotoNaskhArabic", "normal");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    doc.addFont("NotoNaskhArabic-Bold.ttf", "NotoNaskhArabic", "bold");

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                bnfs.forEach((bnf, index) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (index > 0) doc.addPage([CARD_WIDTH, CARD_HEIGHT], "landscape");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const cardData: IDCardData = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    beneficiaryName: bnf.l_benef_name || '', governorate: bnf.gov_name || '', district: bnf.mud_name || '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        uzla: bnf.hh_ozla_name || '', village: bnf.hh_vill_name || '', beneficiaryId: String(bnf.l_id || ''),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cardExpiry: bnf.expiry_date || "2024-01-31",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                educatorName: educator
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               drawCardFront(doc, cardData);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               doc.addPage([CARD_WIDTH, CARD_HEIGHT], "landscape");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               drawCardBack(doc);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       const safeName = educator.replace(/[^a-zA-Z0-9\u0600-\u06FF \-_]/g, "_").trim();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   zip.file(`${safeName}_ID_Cards.pdf`, doc.output("arraybuffer"));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           educatorsProcessed++;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       postMessage({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       type: 'progress',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       status: `Generating PDFs for ${safeName}...`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       progress: Math.round((educatorsProcessed / totalEducators) * 100),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       current: educatorsProcessed,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       total: totalEducators
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           postMessage({ type: 'progress', status: 'Zipping files...', progress: 99 });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   const zipContent = await zip.generateAsync({ type: "arraybuffer" });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           self.postMessage({ type: 'done-all', data: zipContent }, [zipContent]);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               } catch (error: any) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       postMessage({ type: 'error', error: error.message });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           };
